name: Create single-file PR (workflow_run)

on:
  workflow_run:
    workflows: ["Create single-file PR (Trigger on review comment)"]
    types: [completed]

permissions:
  actions: read
  contents: write
  pull-requests: write

jobs:
  generate-branch-token:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      branch_token: ${{ steps.app-token.outputs.token }}
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.SPLICEBOT_TESTING_APP_ID }}
          private-key: ${{ secrets.SPLICEBOT_TESTING_PRIVATE_KEY }}
          # needed since the app is installed on the fork repo, not this one
          owner: leanprover-community

  run-reusable:
    needs: generate-branch-token
    uses: leanprover-community/SpliceBot/.github/workflows/splice_wf_run.yaml@master
    with:
      source_workflow: ${{ github.event.workflow_run.name }}
      # Optional: push PR branches to a dedicated fork.
      push_to_fork: leanprover-community/SpliceBot-testing-fork
      # Optional fork-mode override; default is "false" when omitted.
      # maintainer_can_modify: "true"
    secrets:
      # token: ${{ secrets.SPLICE_BOT_TOKEN }}
      branch_token: ${{ needs.generate-branch-token.outputs.branch_token }}
