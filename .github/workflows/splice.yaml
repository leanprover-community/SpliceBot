name: Create single-file PR from review comment (Reusable)

on:
  workflow_call:
    inputs:
      base_ref:
        description: 'Base branch to compare against (optional)'
        required: false
        type: string
        default: master
      trigger_string:
        description: 'Command string that must appear at the start of a line in the review comment'
        required: false
        type: string
        default: splice-bot

permissions:
  contents: write         # needed to push a branch
  pull-requests: write    # needed to open a PR

jobs:
  create-single-file-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Extract essentials from event (and optionally filter for suggestions)
        id: extract
        uses: actions/github-script@v7
        env:
          BASE_REF_INPUT: ${{ inputs.base_ref }}
          TRIGGER_STRING: ${{ inputs.trigger_string }}
        with:
          script: |
            // --- Helpers ---
            // Escape string for safe usage inside a RegExp literal (treat user input as plain text)
            function escapeForRegex(s) {
              return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            const comment = context.payload?.comment;
            const pr = context.payload?.pull_request;
            const body = comment?.body || "";
            const trigger = process.env.TRIGGER_STRING || "splice-bot";
            const baseRefFromInput = process.env.BASE_REF_INPUT || "master";

            core.info(`Trigger string: "${trigger}"`);
            core.info(`Escaped to: "${escapeForRegex(trigger)}"`);
            core.info(`Comment body:\n---\n${body}\n---`);

            // Build regex: start-of-line, no leading whitespace, case-insensitive, multiline
            const pattern = new RegExp(`^${escapeForRegex(trigger)}\\b`, 'im');

            if (!pattern.test(body)) {
              core.info(`No "${trigger}" found at the start of any line, skipping.`);
              core.setOutput("skip", "true");
              return;
            }

            const path = comment?.path;
            if (!path) {
              core.info("This review comment is not on a file diff (no .path). Nothing to do.");
              core.setOutput("skip", "true");
              return;
            }

            if (!pr) {
              core.info("No pull_request object on this event.");
              core.setOutput("skip", "true");
              return;
            }

            // Gather PR metadata (for logging and outputs)
            const prNumber = pr.number;
            const baseRepoFullName = pr.base?.repo?.full_name;
            const headSha = pr.head?.sha;
            const headRepoFullName = pr.head?.repo?.full_name;

            if (!baseRepoFullName || !headRepoFullName || !headSha) {
              core.info("Missing required PR details (base/head repos or head sha).");
              core.setOutput("skip", "true");
              return;
            }

            const filename = path.split("/").pop();
            core.info(`File path: ${path}`);
            core.info(`Filename: ${filename}`);
            core.info(`PR #${prNumber} | base: ${baseRefFromInput} | head sha: ${headSha}`);
            core.info(`head repo: ${headRepoFullName} | base repo: ${baseRepoFullName}`);

            // Outputs for downstream steps
            core.setOutput("skip", "false");
            core.setOutput("file_path", path);
            core.setOutput("pr_number", String(prNumber));
            core.setOutput("base_ref", baseRefFromInput);
            core.setOutput("base_repo", baseRepoFullName);
            core.setOutput("head_repo", headRepoFullName);

      - name: Check out BASE (PR base repo @ base_ref)
        if: steps.extract.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.extract.outputs.base_repo }}
          ref: ${{ steps.extract.outputs.base_ref }}
          fetch-depth: 0
          path: base

      - name: Check out HEAD (PR head repo)
        if: steps.extract.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.extract.outputs.head_repo }}
          fetch-depth: 0
          path: head

      - name: Create branch and copy the single file
        if: steps.extract.outputs.skip != 'true'
        id: branch_and_copy
        run: |
          set -euo pipefail

          FILE_PATH="${{ steps.extract.outputs.file_path }}"
          PR_NUMBER="${{ steps.extract.outputs.pr_number }}"
          BASE_REF="${{ steps.extract.outputs.base_ref }}"

          # Only keep alphanumeric characters from file name to make a safe branch name
          SAFE_FILE="$(echo "$FILE_PATH" | sed 's/[^0-9A-Z]*//g' | tr -d '\n')"
          BRANCH="bot/file-${SAFE_FILE}-from-PR${PR_NUMBER}"

          echo "BRANCH=$BRANCH" | tee -a "$GITHUB_OUTPUT"

          cd base
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout "${BASE_REF}"

          # Ensure directory exists for the target file
          mkdir -p "$(dirname "$FILE_PATH")"

          # Copy the file from HEAD if present
          if [ -f "../head/${FILE_PATH}" ]; then
            echo "Copying file from PR head: ${FILE_PATH}"
            cp -f "../head/${FILE_PATH}" "${FILE_PATH}"
            git add "${FILE_PATH}"
          else
            echo "File not present at PR head path: ${FILE_PATH}"
          fi

          if git diff --cached --quiet; then
            echo "No changes staged for ${FILE_PATH} vs base ${BASE_REF}"
            echo "NO_CHANGES=true" | tee -a "$GITHUB_OUTPUT"
            exit 0
          fi

      - name: Create Pull Request
        if: steps.extract.outputs.skip != 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          path: base
          base: ${{ steps.extract.outputs.base_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Automated addition of changes in ${{ steps.extract.outputs.file_path }}"
          title: "chore(${{ steps.extract.outputs.file_path }}): automated extraction"
          body: "This PR was automatically created from a review comment on PR #${{ steps.extract.outputs.pr_number }}."
          branch: ${{ steps.branch_and_copy.outputs.BRANCH }}
          branch-suffix: random
          delete-branch: true

      - name: Comment back on the original PR
        if: steps.extract.outputs.skip != 'true' && steps.branch_and_copy.outputs.NO_CHANGES != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const originalPrNumber = Number('${{ steps.extract.outputs.pr_number }}');
            const repoFull = '${{ steps.extract.outputs.base_repo }}';
            const [owner, repo] = repoFull.split('/');
            const automatedPrNumber = '${{ steps.cpr.outputs.pull-request-number }}';
            const filePath = '${{ steps.extract.outputs.file_path }}';

            const body = `Split off the changes to **${filePath}** in #${automatedPrNumber}`;
            await github.rest.issues.createComment({ owner, repo, issue_number: originalPrNumber, body });
